# DeltaX 현재 상태 & 의사결정 노트 (web3 유지 vs web2 전환)

## 1. 배경

- 초기 의도: “투명한 베팅/정산”을 web3로 제공.
- 현재 구현: Sui Move 기반 DEL/BettingPool/Settlement 로직 존재, 지갑으로 베팅 트랜잭션 승인 가능.
- 남은 기간: 4일.

## 2. 현 구현 요약

- 온체인
  - DEL 발행/베팅 풀/정산( Settlement )/배당(distribute) 로직 존재.
    - `contracts/sources/del.move`, `contracts/sources/betting.move`
  - Settlement에 가격, 승자, payout_ratio, 수수료 기록 (Shared Object).
  - 지갑 서명 기반 베팅(place_bet) 실행 플로우는 서버 API로 구현되어 있음.
    - `POST /api/bets` → `POST /api/bets/execute`
- 오프체인
  - 라운드/정산 크론(Job 1~6) 라우트는 존재하나, 현재는 DB 기반 정산만 수행.
    - `app/api/cron/**`, `lib/rounds/service.ts`
  - 가격 스냅샷 API는 있으나(open/finalize 크론은 아직 mock price 사용).
    - `GET /api/price/snapshot` 존재, `POST /api/cron/rounds/{open,finalize}`는 mock
  - 출석 보상(DEL 민팅) 관련 API/서비스는 현재 레포에서 확인되지 않음(미구현으로 판단).

## 3. 핵심 고민

- web3 USP(강제력/투명성/소유) vs 오버엔지니어링:
  - 현재 DEL은 거래 불가, 운영자 발행 → 포인트에 가깝다.
  - 승자/가격 입력을 우리가 정하면 중앙 신뢰가 크다.
  - 지갑/서명 마찰 대비 사용자 체감 가치가 충분한가?

## 4. 선택지

- A) web3 축소 유지
  - 승자 산식 단순화(시가/종가 절대 수익률).
  - 크론이 온체인 lock/finalize/payout 호출.
  - Settlement(가격/승자/배당/수수료) 프론트 노출로 “투명 정산” 어필.
  - 입력 신뢰 최소 보강: 서명 2-of-3 등 멀티시그 서명 검증(간이).
- B) web2 전환
  - 온체인/지갑 경로 비활성화, 베팅/정산/포인트를 서버+DB로 일원화.
  - 차별점은 UX/차트/룰/게임화에 집중.

## 5. A안(web3 유지) 시 남은 작업

### 5.1 온체인 라운드 라이프사이클 연결

- 크론 → 온체인 호출 구현: `create_pool`, `lock_pool`, `finalize_round`, `distribute_payout` (현재 미구현)
- AdminCap 운영 플로우 확정 및 서버에서 사용(현재 env만 존재하고 사용처 미확인)

### 5.2 산식/정합성(중요)

- 승자 산식 확정 및 “온체인 vs 오프체인” 정합성 통일
  - 온체인(`betting.move`): 절대 변동(방향 무시) 기반
  - 오프체인(`lib/rounds/calculator.ts`): 부호 포함 변동률 기반
- 가격 입력 파이프: 시가/종가 스냅샷을 실제 소스로 가져와 저장하고 finalize 입력값으로 사용
  - `GET /api/price/snapshot`을 크론에서 사용하도록 연결 필요 (현재 open/finalize는 mock)

### 5.3 부가 기능(마감 기준)

- 출석 보상: DEL 민트/전송 단순 흐름 (현재 미구현)
- 프론트: 온체인 풀/Settlement 조회 “정산 영수증” 뷰 추가 (이 문서 범위 밖이지만, USP 전달에 필수)
- (선택) 서명/멀티시그 검증: 가격 payload에 다중 서명 붙이고 온체인 검증

## 6. B안(web2 전환) 시 작업

- 온체인/지갑 UI 비활성화, 서버 API로 베팅/정산 처리.
- 승자 산식 오프체인 확정(차트 팀 산식 호출).
- 포인트/보상은 DB 기록 또는 서버 발행 토큰으로 처리.
- 기존 온체인 코드·크론 호출 경로 정리.

## 7. 리스크 & 기회비용

- 시간(4일): web3 유지 시 크론/정산/프런트 증빙/테스트를 압축해야 함.
- 사용자 경험: 서명 마찰을 감수할 만큼 “투명 정산”을 눈에 보이게 제공해야 가치가 전달됨.
- 모방 가능성: web2로 가면 룰/차트/UX 차별만으로 승부해야 하므로 모방 리스크↑.

## 8. 의사결정 가이드

- 우리가 반드시 체인으로 강제/증명하고 싶은 것이 있는가?
  - 예: 풀 잔액/배당/수수료 조작 불가, 정산 영수증 공개.
- 4일 내 이를 “눈에 보이게” 전달할 수 있는가?
  - 예: Settlement 뷰, 온체인 조회 링크.
- 없다면 web2로 단순화하고, UX/차트/룰에 집중.
- 있다면 A안으로 가되 산식 단순화 + 필수 최소 기능만 마감.

## 9. 제안 (개인 의견)

- 갈아엎기 아깝다면 A안으로 최소 스코프: 시가/종가 승자, 크론 정산, Settlement 뷰, 서명은 간소(옵션).
- “투명 정산”을 사용자에게 보여줄 수 없다면 B안으로 전환하는 게 현실적.

---

## 10. 빠른 체크리스트 (현재 상태 / 남은 작업)

- [DONE] 온체인 컨트랙트(풀/베팅/정산/배당) 존재 + 테스트 존재
- [DONE] 온체인 베팅(place_bet) 실행 플로우(서버 prepare/execute) 존재
- [PARTIAL] 가격 스냅샷 API는 있으나 크론에서 실제 사용/저장하지 않음
- [TODO] 온체인 풀 생성/잠금/정산/배당을 크론에서 호출하는 코드
- [TODO] AdminCap 운영(보관/서명 주체/키 관리/환경변수/감사 로그) 확정 및 구현
- [DECISION] 승자 산식: 온체인/오프체인 정합성 통일(방향 포함 vs 방향 무시)
- [TODO] 출석 보상(DEL 민팅) 엔드포인트/중복 방지/저장 로직
