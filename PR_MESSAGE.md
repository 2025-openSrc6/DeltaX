# DEL 잔액 동기화 최적화 및 성능 개선

## 📋 요약

DEL 잔액 동기화 비용을 대폭 절감하기 위해 증분 동기화 방식과 이벤트 기반 즉시 동기화를 도입했습니다.

## 🎯 목표

- **비용 절감**: 전체 유저 동기화 → 최근 활동 유저만 동기화 (약 90~95% 절감)
- **실시간성 향상**: 민팅/베팅 성공 시 해당 유저만 즉시 동기화
- **성능 개선**: 메인 페이지 로딩 상태 최적화

## 🔧 변경 사항

### 1. 증분 동기화 (Incremental Sync)

**파일**: `app/api/cron/sync-del-balances/route.ts`

- 최근 5분 이내 활동한 유저만 동기화
- `pointTransactions`에서 최근 거래가 있는 유저 필터링
- `users.updatedAt`이 최근인 유저도 포함
- `?force=true` 파라미터로 전체 동기화 가능

**효과**:

- 기존: 매번 전체 유저 동기화 (예: 1000명)
- 개선: 최근 활동 유저만 (예: 50~100명)
- **절감률: 약 90~95%**

### 2. 이벤트 기반 즉시 동기화

**파일**:

- `lib/users/service.ts` - 민팅 성공 시
- `lib/bets/service.ts` - 베팅 성공 시
- `lib/users/repository.ts` - `updateBalance()` 메서드 추가

- 민팅/베팅 성공 시 해당 유저만 즉시 동기화
- 비동기 처리로 성능 영향 최소화
- 실패해도 주기적 동기화에서 처리

### 3. 로딩 상태 최적화

**파일**: `app/page.tsx`

- 초기 로드 시에만 로딩 상태 표시
- 주기적 업데이트(10초)는 조용히 수행
- 불필요한 리렌더링 방지

## 📊 성능 개선

### 동기화 비용 비교

| 항목         | 기존               | 개선 후                   | 절감률 |
| ------------ | ------------------ | ------------------------- | ------ |
| 동기화 대상  | 전체 유저 (1000명) | 최근 활동 유저 (50~100명) | 90~95% |
| Sui RPC 호출 | 1000회             | 50~100회                  | 90~95% |
| 실행 시간    | ~10초              | ~1초                      | 90%    |

### 동기화 전략

```
┌─────────────────────────────────────┐
│  주기적 크론 (5분마다)              │
│  → 증분 동기화 (최근 활동 유저만)    │
└─────────────────────────────────────┘
           +
┌─────────────────────────────────────┐
│  이벤트 기반 즉시 동기화              │
│  → 민팅/베팅 성공 시 해당 유저만     │
└─────────────────────────────────────┘
```

## 🧪 테스트 방법

### 1. 증분 동기화 테스트

```bash
# 증분 동기화 (기본)
curl -X POST "https://your-domain.com/api/cron/sync-del-balances" \
  -H "Authorization: Bearer YOUR_CRON_SECRET"

# 전체 동기화 (강제)
curl -X POST "https://your-domain.com/api/cron/sync-del-balances?force=true" \
  -H "Authorization: Bearer YOUR_CRON_SECRET"
```

### 2. 즉시 동기화 테스트

1. 유저 로그인 → 민팅 성공 → 잔액 즉시 동기화 확인
2. 베팅 성공 → 잔액 즉시 동기화 확인

### 3. 로딩 상태 테스트

1. 메인 페이지 접속 → 초기 로딩만 표시
2. 10초 후 자동 업데이트 → 로딩 없이 조용히 업데이트

## 📝 변경된 파일

```
M  app/api/cron/sync-del-balances/route.ts  # 증분 동기화 로직
M  lib/users/service.ts                     # 민팅 시 즉시 동기화
M  lib/users/repository.ts                  # updateBalance() 추가
M  lib/bets/service.ts                       # 베팅 시 즉시 동기화
M  app/page.tsx                             # 로딩 상태 최적화
```

## ⚠️ 주의사항

1. **전체 동기화**: 하루 1회 정도만 `?force=true`로 실행 권장
2. **동기화 윈도우**: 현재 5분으로 설정되어 있으며, 필요시 조정 가능
3. **에러 처리**: 즉시 동기화 실패 시 주기적 동기화에서 처리되므로 안전

## 🔍 관련 이슈

- 비용 최적화 요구사항
- 실시간 잔액 동기화 개선

## ✅ 체크리스트

- [x] 증분 동기화 로직 구현
- [x] 이벤트 기반 즉시 동기화 구현
- [x] 로딩 상태 최적화
- [x] 에러 처리 및 로깅
- [x] 코드 리뷰 준비

---

**예상 비용 절감**: 약 90~95% (유저 활동 패턴에 따라 변동)
